<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>V8 vs EV ‚Äî Street Laughs</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0f14"/>
<style>
  :root{--ui:#121620;--txt:#eaf1ff;--accent:#ffd24a}
  html,body{height:100%;margin:0;background:#0b0f14;color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden}
  #wrap{position:relative;width:100%;height:100%}
  #game{display:block;width:100%;height:100%}
  #hud{position:absolute;left:10px;top:10px;background:#0008;padding:6px 10px;border-radius:8px;font:14px monospace}
  #menuOverlay{position:absolute;inset:0;background:rgba(0,0,0,.82);display:flex;align-items:center;justify-content:center;z-index:10}
  #menu{background:#0f141c;border:1px solid #2a3242;border-radius:12px;padding:18px;width:min(520px,92%)}
  #menu h2{margin:.2em 0 .4em}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:.5em 0}
  .toggle{appearance:none;width:48px;height:28px;border-radius:28px;background:#2a3242;position:relative;outline:none;cursor:pointer}
  .toggle:checked{background:#1c7d42}
  .toggle:before{content:"";position:absolute;top:3px;left:3px;width:22px;height:22px;background:#fff;border-radius:50%;transition:.15s}
  .toggle:checked:before{left:23px}
  button{padding:10px 14px;border-radius:10px;border:1px solid #3b455a;background:#1a2130;color:var(--txt);font-weight:600}
  button:hover{filter:brightness(1.06);cursor:pointer}
  /* pixel buttons */
  .arrow{position:absolute;bottom:12px;width:22vw;max-width:170px;opacity:.55;transition:.08s;user-select:none}
  #leftBtn{left:12px}
  #rightBtn{right:12px}
  .arrow:active{opacity:.9;transform:scale(1.02)}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game" width="480" height="800"></canvas>
  <div id="hud">Score: <span id="score">0</span> | HI: <span id="hi">0</span></div>
  <div id="menuOverlay">
    <div id="menu">
      <h2>üèÅ V8 vs EV ‚Äî Street Laughs</h2>
      <p>Trans Am '75 vs. E-Autos. Weiche aus, sammle Punkte, mach L√§rm üòÑ</p>
      <div class="row"><span>üéµ Musik</span><input id="musT" type="checkbox" class="toggle" checked></div>
      <div class="row"><span>üîä SFX</span><input id="sfxT" type="checkbox" class="toggle" checked></div>
      <div class="row"><span>üì≥ Vibration</span><input id="vibT" type="checkbox" class="toggle" checked></div>
      <div class="row" style="justify-content:center;gap:12px"><button id="startBtn">Start!</button><button id="closeBtn">Schlie√üen</button></div>
      <small>Steuerung: Pfeile unten oder **Wischen**. Doppeltippen = Nitro.</small>
    </div>
  </div>
  <img id="leftBtn" class="arrow" src="assets/arrow-left.png" alt="left">
  <img id="rightBtn" class="arrow" src="assets/arrow-right.png" alt="right">
</div>
<script>
const canvas=document.getElementById('game'); const ctx=canvas.getContext('2d');
const W=canvas.width, H=canvas.height;
const lanes=[W*0.22, W*0.5, W*0.78];
let state='menu'; let score=0, hi=+localStorage.getItem('v8ev_hi')||0;
document.getElementById('hi').textContent=hi;

const imgTA=new Image(); imgTA.src='assets/transam.png';
const imgEV=new Image(); imgEV.src='assets/fiat.png';
const imgBG=new Image(); imgBG.src='assets/bg.png';

const player={lane:1, y:H*0.7, w:84, h:126, nitro:0};
const objs=[];

// ----- audio: nicer chiptune loop + sfx -----
const AC = new (window.AudioContext||window.webkitAudioContext)();
const gMaster=AC.createGain(); gMaster.connect(AC.destination); gMaster.gain.value=0.7;
const gMusic=AC.createGain(); gMusic.connect(gMaster); gMusic.gain.value=0.4;
const gSfx=AC.createGain(); gSfx.connect(gMaster); gSfx.gain.value=0.9;
let musicTimer=null, bass=null, lead=null, hatInt=null;
function startMusic(){
  if(!document.getElementById('musT').checked) return;
  stopMusic();
  const now=AC.currentTime;
  // bass
  bass=AC.createOscillator(); const gb=AC.createGain(); bass.type='square'; bass.connect(gb); gb.connect(gMusic); gb.gain.value=0.08; bass.start();
  // lead
  lead=AC.createOscillator(); const gl=AC.createGain(); lead.type='triangle'; lead.connect(gl); gl.connect(gMusic); gl.gain.value=0.06; lead.start();
  // hihat via noise
  const noise=AC.createBufferSource(); const buffer=AC.createBuffer(1, AC.sampleRate*1, AC.sampleRate);
  const data=buffer.getChannelData(0); for(let i=0;i<data.length;i++){ data[i]=Math.random()*2-1; }
  const hn=AC.createGain(); hn.gain.value=0; noise.connect(hn); hn.connect(gMusic); noise.loop=true; noise.start();
  hatInt=setInterval(()=>{ hn.gain.cancelScheduledValues(AC.currentTime); hn.gain.setValueAtTime(0.25, AC.currentTime); hn.gain.exponentialRampToValueAtTime(0.001, AC.currentTime+0.04); }, 120);
  noise.buffer=buffer;

  const bassNotes=[55,55,55,41.2,55,55,55,49];
  const leadNotes=[220,0,196,0,174,0,196,0];
  musicTimer=setInterval(()=>{
    const t=AC.currentTime;
    bass.frequency.setTargetAtTime(bassNotes[(Math.floor(t*4))%bassNotes.length], t, 0.03);
    const ln = leadNotes[(Math.floor(t*4))%leadNotes.length];
    if(ln>0) lead.frequency.setTargetAtTime(ln, t, 0.02);
  }, 120);
}
function stopMusic(){
  if(musicTimer){ clearInterval(musicTimer); musicTimer=null; }
  if(hatInt){ clearInterval(hatInt); hatInt=null; }
  try{ bass&&bass.stop(); }catch(e){} try{ lead&&lead.stop(); }catch(e){}
  bass=null; lead=null;
}
function sfx(type){
  if(!document.getElementById('sfxT').checked) return;
  const o=AC.createOscillator(); const g=AC.createGain(); o.connect(g); g.connect(gSfx);
  const now=AC.currentTime;
  if(type==='hit'){ o.type='sawtooth'; o.frequency.setValueAtTime(80, now); g.gain.setValueAtTime(0.3, now); g.gain.exponentialRampToValueAtTime(0.001, now+0.25); }
  if(type==='coin'){ o.type='square'; o.frequency.setValueAtTime(900, now); o.frequency.exponentialRampToValueAtTime(1500, now+0.1); g.gain.setValueAtTime(0.12, now); g.gain.exponentialRampToValueAtTime(0.001, now+0.25); }
  if(type==='nitro'){ o.type='triangle'; o.frequency.setValueAtTime(160, now); o.frequency.exponentialRampToValueAtTime(60, now+0.45); g.gain.setValueAtTime(0.22, now); g.gain.exponentialRampToValueAtTime(0.001, now+0.45); }
  o.start(now); o.stop(now+0.5);
}
function vibrate(p){ if(!document.getElementById('vibT').checked) return; if('vibrate' in navigator) navigator.vibrate(p); }

// ----- menu -----
const overlay=document.getElementById('menuOverlay');
function showMenu(){ overlay.style.display='flex'; }
function hideMenu(){ overlay.style.display='none'; }
document.getElementById('startBtn').onclick=()=>{ startGame(); };
document.getElementById('closeBtn').onclick=()=>{ hideMenu(); state='playing'; AC.resume(); startMusic(); };
function startGame(){
  objs.length=0; score=0; player.lane=1; player.nitro=0;
  hideMenu(); state='playing'; AC.resume(); startMusic();
}

// spawn with fairness
function spawn(){
  if(objs.length<1 || (objs[objs.length-1].y>200 && Math.random()<0.04)){
    let lane = Math.floor(Math.random()*3);
    if(lane===player.lane && Math.random()<0.6) lane=(lane+1)%3; // leichte Varianz
    objs.push({lane, y:-150, w:84, h:126, speed:5+Math.random()*1.6});
  }
}

function update(){
  const mul = 1+(player.nitro>0?0.6:0);
  for(const o of objs) o.y += o.speed*mul;
  for(let i=objs.length-1;i>=0;i--){
    const o=objs[i];
    if(o.y>H+160) objs.splice(i,1);
    else if(Math.abs(o.y-player.y)<100 && o.lane===player.lane){
      state='menu'; showMenu(); sfx('hit'); vibrate([25,40,25]);
      hi=Math.max(hi,Math.floor(score)); localStorage.setItem('v8ev_hi',hi); document.getElementById('hi').textContent=hi;
      stopMusic(); return;
    }
  }
  score += 0.7*(1+(player.nitro>0?0.5:0));
  document.getElementById('score').textContent = Math.floor(score);
  if(player.nitro>0) player.nitro--;
}

function draw(){
  ctx.clearRect(0,0,W,H);
  ctx.drawImage(imgBG,0,0,W,H);
  for(const o of objs){ ctx.drawImage(imgEV, lanes[o.lane]-o.w/2,o.y,o.w,o.h); }
  ctx.drawImage(imgTA, lanes[player.lane]-player.w/2, player.y, player.w, player.h);
}

function loop(){ if(state==='playing'){ spawn(); update(); } draw(); requestAnimationFrame(loop); }
loop();

// controls: keyboard
window.addEventListener('keydown', e=>{
  if(state!=='playing') return;
  if(e.key==='ArrowLeft' || e.key==='a'){ player.lane=Math.max(0,player.lane-1); vibrate([10]); }
  if(e.key==='ArrowRight' || e.key==='d'){ player.lane=Math.min(2,player.lane+1); vibrate([10]); }
  if(e.key==='ArrowUp' || e.key==='w'){ if(player.nitro<=0){ player.nitro=120; sfx('nitro'); } }
});

// swipe gestures
let touchStart=null;
canvas.addEventListener('touchstart', e=>{ touchStart=e.changedTouches[0]; });
canvas.addEventListener('touchend', e=>{
  const t=e.changedTouches[0]; if(!touchStart) return;
  const dx=t.clientX - touchStart.clientX; const dy=t.clientY - touchStart.clientY;
  if(Math.abs(dx)>40 && Math.abs(dx)>Math.abs(dy)){
    if(dx<0) { player.lane=Math.max(0,player.lane-1); } else { player.lane=Math.min(2,player.lane+1); }
    vibrate([10,20,10]);
  } else if(Math.abs(dy)<20){ if(player.nitro<=0){ player.nitro=120; sfx('nitro'); } }
  touchStart=null;
});

// on-screen pixel arrows
function bindArrow(id, dir){
  const el=document.getElementById(id);
  let hold=null;
  const step=()=>{
    if(state!=='playing') return;
    if(dir==='left') player.lane=Math.max(0,player.lane-1);
    else player.lane=Math.min(2,player.lane+1);
    vibrate([8]);
    hold=setTimeout(step, 130);
  };
  el.addEventListener('touchstart', (e)=>{ e.preventDefault(); step(); });
  el.addEventListener('touchend', ()=>{ clearTimeout(hold); hold=null; });
  el.addEventListener('mousedown', (e)=>{ e.preventDefault(); step(); });
  window.addEventListener('mouseup', ()=>{ clearTimeout(hold); hold=null; });
}
bindArrow('leftBtn','left'); bindArrow('rightBtn','right');

// PWA SW
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js')); }
</script>
</body>
</html>
