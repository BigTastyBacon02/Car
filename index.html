<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>V8 vs EV ‚Äî Street Laughs</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#10141a"/>
  <style>
    :root{--bg:#0e1016;--ui:#1e2430;--accent:#ffcc00;--accent2:#00ffd1;--text:#e7ecf1}
    *{box-sizing:border-box} html,body{height:100%; margin:0; background:linear-gradient(180deg,#10141a,#0a0d12)}
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text);}
    #wrap{display:flex; min-height:100%; align-items:center; justify-content:center; padding:16px}
    #card{width:min(960px,100%); background:rgba(20,24,32,.65); border:1px solid #2a3242; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.4); overflow:hidden}
    header{padding:14px 16px; display:flex; gap:12px; align-items:center; background:linear-gradient(180deg,#141a22,#0e131b)}
    header img{width:40px;height:40px}
    h1{font-size:20px; margin:0}
    .grid{display:grid; grid-template-columns:1fr 300px; gap:0; align-items:stretch}
    #gamePane{background:#0b0e14; display:flex; align-items:center; justify-content:center; border-top:1px solid #242b39; position:relative}
    canvas{width:100%; height:100%; image-rendering: pixelated; background:#0a0e14}
    #side{padding:14px; border-left:1px solid #242b39; background:#0e131b}
    #btns button,#installBtn{width:100%; padding:12px 14px; margin:8px 0; border-radius:10px; border:1px solid #2a3242; background:#16202c; color:var(--text); font-weight:600}
    #btns button.primary{background:linear-gradient(180deg,#2a2f3b,#1c2230); border-color:#3b455a}
    #btns button:hover,#installBtn:hover{filter:brightness(1.08); cursor:pointer}
    .row{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .label{opacity:.8}
    .toggle{appearance:none; width:48px; height:28px; border-radius:28px; background:#2a3242; position:relative; outline:none; cursor:pointer}
    .toggle:checked{background:#1c7d42}
    .toggle:before{content:""; position:absolute; top:3px; left:3px; width:22px;height:22px; background:white; border-radius:50%; transition:.15s}
    .toggle:checked:before{left:23px}
    #footer{font-size:12px; opacity:.7; padding:8px 14px; border-top:1px solid #242b39}
    #menuOverlay{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(5,7,10,.84); z-index:3}
    #menuCard{background:#0f141c; border:1px solid #2a3242; border-radius:12px; padding:18px; width:min(520px,95%)}
    #menuCard h2{margin:0 0 8px 0}
    #menuCard p{margin:6px 0}
    .kbd{padding:.15em .45em; border:1px solid #3b455a; border-radius:6px; background:#121721; font-size:.9em}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} #side{border-left:none; border-top:1px solid #242b39} }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="card">
      <header>
        <img src="icons/icon-192.png" alt="logo">
        <div>
          <h1>V8 vs EV ‚Äî Street Laughs</h1>
          <div style="opacity:.8">‚Äô75 Trans Am vs E-Kisten ‚Äî ps1/ps2 low poly vibe</div>
        </div>
      </header>
      <div class="grid" style="min-height:70vh;">
        <div id="gamePane">
          <canvas id="game" width="480" height="800"></canvas>
          <div id="menuOverlay" aria-hidden="false">
            <div id="menuCard">
              <h2>üèÅ Men√º</h2>
              <p>Weiche den E-Autos aus, sammle Benzinkanister und halte den V8 am Leben.</p>
              <p><strong>Steuerung</strong></p>
              <p>‚ÜîÔ∏è <span class="kbd">‚Üê</span>/<span class="kbd">‚Üí</span> oder Wisch nach links/rechts: Spur wechseln</p>
              <p>‚è´ <span class="kbd">‚Üë</span> / Tippen doppelt: Nitro-Boost</p>
              <p><small>Vibration auf Ger√§ten mit Haptik. Ton kann im Panel rechts aus/an geschaltet werden.</small></p>
              <div class="row" style="margin-top:10px">
                <button id="startBtn" class="primary">Start!</button>
                <button id="closeMenu">Schlie√üen</button>
              </div>
            </div>
          </div>
        </div>
        <aside id="side">
          <div id="btns">
            <button id="pauseBtn" class="primary">Pause / Men√º</button>
            <div class="row"><span class="label">üéµ Musik</span><input id="musT" type="checkbox" class="toggle" checked></div>
            <div class="row"><span class="label">üîä SFX</span><input id="sfxT" type="checkbox" class="toggle" checked></div>
            <div class="row"><span class="label">üì≥ Vibration</span><input id="vibT" type="checkbox" class="toggle" checked></div>
            <button id="installBtn" hidden>Auf Startbildschirm installieren</button>
          </div>
          <hr style="border-color:#242b39; opacity:.4">
          <p><strong>Highscore:</strong> <span id="hi">0</span></p>
          <p id="tips" style="opacity:.8">Tipp: E-Autos haben Drehmoment ‚Äì aber keinen Sound. üòè</p>
        </aside>
      </div>
      <div id="footer">Made for GitHub Pages ‚Ä¢ PWA offline ready ‚Ä¢ Nur zu Spa√üzwecken ‚úåÔ∏è</div>
    </div>
  </div>
  <script>
  // helpers to show/hide overlay reliably on all browsers
  const overlay = document.getElementById('menuOverlay');
  const showMenu = () => { overlay.hidden=false; overlay.style.display='flex'; overlay.setAttribute('aria-hidden','false'); };
  const hideMenu = () => { overlay.hidden=true; overlay.style.display='none'; overlay.setAttribute('aria-hidden','true'); };

  // --- PWA install prompt ---
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; const b=document.getElementById('installBtn'); b.hidden=false; b.onclick=async(ev)=>{ ev.preventDefault(); if(deferredPrompt){ deferredPrompt.prompt(); await deferredPrompt.userChoice; } b.textContent="Installations-Dialog ge√∂ffnet"; };});
  if ('serviceWorker' in navigator) { window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js')); }

  // --- tiny pseudo-3D runner ---
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  const lanes = [W*0.22, W*0.5, W*0.78];
  let state = 'menu';
  let last = 0, dt = 0;
  const player = { lane:1, y:H*0.75, speed:5, alive:true, nitro:0 };
  let score=0, hiscore = +localStorage.getItem('v8ev_hi')||0;
  document.getElementById('hi').textContent = hiscore;
  const objs = []; // obstacles & pickups

  // audio via WebAudio so we don't need files
  const AudioC = window.AudioContext || window.webkitAudioContext;
  const AC = new AudioC();
  const gainMaster = AC.createGain(); gainMaster.connect(AC.destination); gainMaster.gain.value=0.6;
  const gainMusic = AC.createGain(); gainMusic.connect(gainMaster); const gainSfx = AC.createGain(); gainSfx.connect(gainMaster);

  let musicNode=null;
  function startMusic(){
    if(!document.getElementById('musT').checked) return;
    if (musicNode) return;
    const o=AC.createOscillator(); const g=AC.createGain(); o.type='square'; o.connect(g); g.connect(gainMusic);
    const now=AC.currentTime;
    g.gain.setValueAtTime(0.08, now);
    function loop(){
      const t=AC.currentTime;
      const beat=0.26; const p=[110, 146.8, 110, 196][Math.floor((t/beat))%4];
      o.frequency.setTargetAtTime(p, t, 0.02);
      musicNode._id = requestAnimationFrame(loop);
    }
    o.start();
    musicNode = {o, g, _id: requestAnimationFrame(loop)};
  }
  function stopMusic(){
    if (!musicNode) return;
    cancelAnimationFrame(musicNode._id);
    try{ musicNode.o.stop(); }catch(e){}
    musicNode=null;
  }
  function sfx(type){
    if(!document.getElementById('sfxT').checked) return;
    const o=AC.createOscillator(); const g=AC.createGain(); o.connect(g); g.connect(gainSfx);
    o.type = type==='hit' ? 'sawtooth':'triangle';
    const now=AC.currentTime;
    if(type==='hit'){ o.frequency.setValueAtTime(60, now); g.gain.setValueAtTime(0.25, now); g.gain.exponentialRampToValueAtTime(0.001, now+0.2);}
    if(type==='coin'){ o.frequency.setValueAtTime(800, now); o.frequency.exponentialRampToValueAtTime(1200, now+0.08); g.gain.setValueAtTime(0.08, now); g.gain.exponentialRampToValueAtTime(0.001, now+0.2);}
    if(type==='nitro'){ o.frequency.setValueAtTime(120, now); o.frequency.exponentialRampToValueAtTime(40, now+0.4); g.gain.setValueAtTime(0.22, now); g.gain.exponentialRampToValueAtTime(0.001, now+0.4);}
    o.start(now); o.stop(now+0.5);
  }

  // UI toggles
  document.getElementById('musT').addEventListener('change', e=>{
    if(e.target.checked){ startMusic(); } else { stopMusic(); }
  });
  document.getElementById('pauseBtn').onclick = ()=>{ state='menu'; showMenu(); };
  document.getElementById('startBtn').onclick = ()=>{ startGame(); };
  document.getElementById('closeMenu').onclick = (ev)=>{ ev.preventDefault(); if(state==='menu'){ state='playing'; } hideMenu(); };

  function startGame(){
    objs.length=0; score=0; player.lane=1; player.alive=true; player.nitro=0;
    state='playing'; hideMenu();
    startMusic(); AC.resume();
  }

  // controls: keyboard + swipe/tap
  window.addEventListener('keydown', (e)=>{
    if(state!=='playing') return;
    if(e.key==='ArrowLeft' || e.key==='a'){ player.lane=Math.max(0,player.lane-1); vibrate([10]); }
    if(e.key==='ArrowRight' || e.key==='d'){ player.lane=Math.min(2,player.lane+1); vibrate([10]); }
    if(e.key==='ArrowUp' || e.key==='w'){ boost(); }
  });
  let tStart=null;
  canvas.addEventListener('touchstart', (e)=>{ tStart=e.changedTouches[0]; });
  canvas.addEventListener('touchend', (e)=>{
    const t=e.changedTouches[0]; if(!tStart) return;
    const dx=t.clientX - tStart.clientX; const dy=t.clientY - tStart.clientY;
    if(Math.abs(dx)>40 && Math.abs(dx)>Math.abs(dy)){
      if(dx<0) { player.lane=Math.max(0,player.lane-1); }
      else { player.lane=Math.min(2,player.lane+1); }
      vibrate([10,30,10]);
    } else if (Math.abs(dy)<20) { boost(); }
    tStart=null;
  });

  function boost(){
    if(player.nitro<=0){ player.nitro=120; sfx('nitro'); vibrate([20,30,20]); }
  }
  function vibrate(p){ if(!document.getElementById('vibT').checked) return; if('vibrate' in navigator) navigator.vibrate(p); }

  function rand(a,b){ return Math.random()*(b-a)+a; }

  function spawn(){
    if(Math.random()<0.035){
      const type = Math.random()<0.82 ? 'ev' : 'can';
      const lane = Math.floor(rand(0,3));
      const y = -80;
      const speed = rand(4.2, 6.8);
      objs.push({type, lane, y, speed});
    }
  }

  function update(){
    const speedMul = 1 + (player.nitro>0 ? 1.1:0);
    objs.forEach(o=> o.y += (o.speed*speedMul));
    for(let i=objs.length-1;i>=0;i--){
      const o=objs[i];
      if(o.y>H+100){ objs.splice(i,1); continue; }
      // collision check
      if(o.type==='ev' && Math.abs(o.y-player.y)<70 && o.lane===player.lane){
        sfx('hit'); vibrate([30,40,30]);
        state='menu'; showMenu();
        player.alive=false;
        hiscore = Math.max(hiscore, Math.floor(score));
        localStorage.setItem('v8ev_hi', hiscore);
        document.getElementById('hi').textContent = hiscore;
        stopMusic();
        return;
      } else if (o.type==='can' && Math.abs(o.y-player.y)<60 && o.lane===player.lane){
        objs.splice(i,1); score+=60; sfx('coin'); vibrate([8,16,8]);
      }
    }
    score += 0.7 * (1 + (player.nitro>0?0.6:0));
    if(player.nitro>0) player.nitro--;
  }

  function drawRoad(){
    ctx.fillStyle = '#091018'; ctx.fillRect(0,0,W,H);
    const horizon = H*0.25;
    const skyGrad = ctx.createLinearGradient(0,0,0,horizon);
    skyGrad.addColorStop(0,'#ee8d3a'); skyGrad.addColorStop(1,'#1a2030');
    ctx.fillStyle=skyGrad; ctx.fillRect(0,0,W,horizon);
    ctx.fillStyle='#2c1c1a';
    for(let i=0;i<7;i++){ ctx.beginPath(); ctx.moveTo(i*120-60,horizon+20); ctx.lineTo(i*120+40,horizon-20); ctx.lineTo(i*120+140,horizon+20); ctx.fill(); }
    ctx.fillStyle='#151a22'; ctx.beginPath();
    ctx.moveTo(0,H); ctx.lineTo(W*0.08,horizon+40); ctx.lineTo(W*0.92,horizon+40); ctx.lineTo(W,H); ctx.closePath(); ctx.fill();
    ctx.strokeStyle='#b21f2d'; ctx.lineWidth=6; ctx.beginPath();
    ctx.moveTo(W*0.09,horizon+40); ctx.lineTo(0,H);
    ctx.moveTo(W*0.91,horizon+40); ctx.lineTo(W,H);
    ctx.stroke();
    ctx.strokeStyle='#f0e68c'; ctx.lineWidth=4;
    for(let i=1;i<3;i++){
      const x0=W*(0.1 + 0.8*(i/3));
      ctx.setLineDash([18,20]);
      ctx.beginPath(); ctx.moveTo(x0,horizon+40); ctx.lineTo(x0,H); ctx.stroke();
    }
    ctx.setLineDash([]);
  }

  // --------- nicer Trans Am '75 (top-down, low poly) ---------
  function drawTransAm(x,y){
    ctx.save(); ctx.translate(x,y); ctx.lineJoin='miter'; ctx.lineCap='butt';
    // body base: black
    ctx.fillStyle='#0b0b0d'; ctx.strokeStyle='#000'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(-42,-64); ctx.lineTo(42,-64); ctx.lineTo(46,-30); ctx.lineTo(40,58); ctx.lineTo(-40,58); ctx.lineTo(-46,-30); ctx.closePath(); ctx.fill(); ctx.stroke();
    // gold pinstripes
    ctx.strokeStyle='#c9a43a'; ctx.lineWidth=2;
    ctx.strokeRect(-40,-58,80,112);
    // hood shaker + firebird decal
    ctx.fillStyle='#111318'; ctx.fillRect(-30,-48,60,34); // hood
    ctx.fillStyle='#202428'; ctx.fillRect(-14,-52,28,14); // shaker
    // stylized firebird
    ctx.fillStyle='#c9a43a';
    ctx.beginPath(); ctx.moveTo(0,-40); ctx.lineTo(10,-32); ctx.lineTo(0,-24); ctx.lineTo(-10,-32); ctx.closePath(); ctx.fill();
    // roof / glass
    ctx.fillStyle='#1a222b'; ctx.fillRect(-30,-10,60,38); // roof glass
    ctx.fillStyle='#0e141b'; ctx.fillRect(-30,22,60,26); // rear glass
    // rear spoiler
    ctx.fillStyle='#111'; ctx.fillRect(-40,56,80,6);
    // wheels
    ctx.fillStyle='#222'; ctx.fillRect(-44,-30,10,22); ctx.fillRect(34,-30,10,22);
    ctx.fillRect(-44,22,10,22); ctx.fillRect(34,22,10,22);
    // license / label
    ctx.fillStyle='#ffcc00'; ctx.fillRect(-18,40,36,14);
    ctx.fillStyle='#111'; ctx.font='bold 10px monospace'; ctx.textAlign='center'; ctx.fillText("75 TA",0,51);
    // subtle highlight
    const g=ctx.createLinearGradient(-42,-64,42,58); g.addColorStop(0,'rgba(255,255,255,0.05)'); g.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=g; ctx.fillRect(-42,-64,84,122);
    ctx.restore();
  }

  function drawEV(x,y,label){
    ctx.save(); ctx.translate(x,y);
    ctx.fillStyle='#5fb3ff'; ctx.strokeStyle='#000'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.rect(-38,-60,76,120); ctx.fill(); ctx.stroke();
    ctx.fillStyle='#0b0f14'; ctx.fillRect(-34,-50,68,30);
    ctx.fillRect(-34,20,68,30);
    ctx.fillStyle='#222'; ctx.fillRect(-40,-30,8,20); ctx.fillRect(32,-30,8,20);
    ctx.fillRect(-40,30,8,20); ctx.fillRect(32,30,8,20);
    ctx.fillStyle='#fff'; ctx.font='bold 12px monospace'; ctx.textAlign='center'; ctx.fillText(label, 0, 0);
    ctx.restore();
  }

  function drawHUD(){
    ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(10,10,150,52);
    ctx.fillStyle='#fff'; ctx.font='16px monospace';
    ctx.fillText('Score: '+Math.floor(score), 20, 32);
    ctx.fillText('Nitro: '+Math.max(0,player.nitro), 20, 52);
  }

  const evNames = ['e-Box','Wattson','Silent-Bee','Sparky','Model Zzz','EcoBrick'];
  function render(){
    drawRoad();
    objs.forEach(o=>{
      const x = lanes[o.lane];
      if(o.type==='ev') drawEV(x, o.y, evNames[o._n??(o._n=Math.floor(Math.random()*evNames.length))]);
      else { // can (fuel)
        ctx.save(); ctx.translate(x,o.y);
        ctx.fillStyle='#ffcc00'; ctx.strokeStyle='#000'; ctx.lineWidth=2;
        ctx.beginPath(); ctx.rect(-18,-18,36,36); ctx.fill(); ctx.stroke();
        ctx.fillStyle='#000'; ctx.font='bold 12px monospace'; ctx.textAlign='center'; ctx.fillText('‚õΩ',0,6);
        ctx.restore();
      }
    });
    drawTransAm(lanes[player.lane], player.y);
    drawHUD();
  }

  function loop(t){
    dt = (t-last)/16.666; last=t;
    if(state==='playing'){ spawn(); update(); }
    render();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // start with menu visible
  showMenu();
  </script>
</body>
</html>
